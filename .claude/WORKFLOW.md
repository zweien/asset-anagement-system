# 长运行代理 - 工作流程指南

## 概述

本文档描述了如何在项目中使用长运行代理框架进行开发。

## 代理类型

### 1. 初始化代理 (Initializer Agent)
- **触发时机**: 项目首次创建或重大重构时
- **指令文件**: `.claude/agents/initializer.md`
- **主要任务**:
  - 设置项目环境
  - 创建详细的功能列表
  - 初始化进度文件
  - 创建初始 Git 提交

### 2. 编码代理 (Coding Agent)
- **触发时机**: 每个开发会话
- **指令文件**: `.claude/agents/coding-agent.md`
- **主要任务**:
  - 读取进度文件了解上下文
  - 选择下一个待开发功能
  - 实现功能并测试
  - 更新进度文件和提交代码

## 会话工作流

```
┌─────────────────────────────────────────────────────────────┐
│                      会话开始                                │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 获取上下文                                               │
│     - pwd                                                   │
│     - 读取 claude-progress.txt                              │
│     - 读取 feature_list.json                                │
│     - git log --oneline -10                                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 验证环境                                                 │
│     - ./init.sh status                                      │
│     - 启动开发服务器                                         │
│     - 验证基本功能正常                                       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 选择下一个功能                                           │
│     - 从 feature_list.json 选择                              │
│     - 优先级最高且 passes: false                             │
│     - 一次只选一个                                           │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 开发与测试                                               │
│     - 编写代码                                               │
│     - 编写测试                                               │
│     - 运行测试验证                                           │
│     - 端到端测试 (如适用)                                    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 更新记录                                                 │
│     - 更新 claude-progress.txt                               │
│     - 更新 feature_list.json (如果测试通过)                  │
│     - Git commit                                             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      会话结束                                │
└─────────────────────────────────────────────────────────────┘
```

## 功能列表管理

### 添加新功能
```json
{
  "id": "FEATURE-002",
  "category": "functional",
  "priority": "medium",
  "description": "用户可以点击按钮提交表单",
  "steps": [
    "打开表单页面",
    "填写必填字段",
    "点击提交按钮",
    "验证提交成功"
  ],
  "acceptance_criteria": [
    "表单验证正常工作",
    "提交后显示成功消息"
  ],
  "passes": false
}
```

### 标记功能完成
**只有当所有测试通过时**，将 `passes` 设为 `true`：
```json
{
  "id": "FEATURE-002",
  "passes": true
}
```

## 进度文件格式

```markdown
## 2026-02-14 - 会话 3

### 完成的工作
- [x] FEATURE-002: 用户表单提交功能
- [x] 添加表单验证测试

### 当前状态
- 进度: 5/20 功能通过 (25%)
- 正在开发: FEATURE-003

### 遇到的问题
- 无

### 下一步
- [ ] 实现 FEATURE-003: 用户登录功能

---
```

## 常见问题

### Q: 发现之前的功能有 bug 怎么办？
A: 优先修复 bug，单独提交修复，然后在进度文件中记录。

### Q: 功能太复杂无法在一个会话完成？
A: 将功能拆分为更小的子功能，更新 feature_list.json。

### Q: 测试一直无法通过？
A: 不要将功能标记为 passes，在进度文件中记录问题，提交当前进度并标注"未完成"。
